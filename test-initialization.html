<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'Initialisation - M√©t√©o Sud France</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f0f2f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .test-pass {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .test-fail {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .test-pending {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .iframe-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .timestamp {
            font-size: 0.9em;
            color: #666;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .metrics {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test d'Initialisation - M√©t√©o Sud France</h1>
        <p class="timestamp">Test d√©marr√© √†: <span id="test-start-time"></span></p>
        
        <div class="test-result test-pending" id="test-1">
            ‚è≥ Test 1: Chargement de l'application modular (consolid√©e)
        </div>
        
        <div class="test-result test-pending" id="test-2">
            ‚è≥ Test 2: V√©rification de l'initialisation non-bloquante
        </div>
        
        <div class="test-result test-pending" id="test-3">
            ‚è≥ Test 3: Test de la gestion d'erreur r√©seau
        </div>
        
        <div class="test-result test-pending" id="test-4">
            ‚è≥ Test 4: Test de la version simplifi√©e de secours
        </div>
        
        <div class="metrics" id="metrics" style="display: none;">
            <h3>üìä M√©triques de Performance</h3>
            <div id="metrics-content"></div>
        </div>
        
        <div>
            <button onclick="runModularTest()">üß™ Tester Version Modulaire</button>
            <button onclick="runSimpleTest()">üß™ Tester Version Simple</button>
            <button onclick="runOfflineTest()">üìµ Simuler Mode Hors Ligne</button>
            <button onclick="clearTests()">üóëÔ∏è Reset Tests</button>
        </div>
        
        <div class="iframe-container" id="app-container" style="display: none;">
            <iframe id="test-frame" src=""></iframe>
        </div>
        
        <div id="console-output" style="margin-top: 20px; padding: 10px; background: #000; color: #0f0; font-family: monospace; border-radius: 4px; display: none;">
            <h4 style="color: white;">Console Output:</h4>
            <div id="console-log"></div>
        </div>
    </div>

    <script>
        let testStartTime = Date.now();
        let currentTest = null;
        let testTimeout = null;
        
        document.getElementById('test-start-time').textContent = new Date().toLocaleString('fr-FR');
        
        function updateTest(testId, status, message) {
            const element = document.getElementById(testId);
            element.className = `test-result test-${status}`;
            
            const icon = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚è≥';
            const elapsed = Date.now() - testStartTime;
            element.innerHTML = `${icon} ${message} <span class="timestamp">(${elapsed}ms)</span>`;
        }
        
        function logToConsole(message) {
            const consoleOutput = document.getElementById('console-output');
            const consoleLog = document.getElementById('console-log');
            consoleOutput.style.display = 'block';
            consoleLog.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }
        
        function runModularTest() {
            clearTests();
            testStartTime = Date.now();
            currentTest = 'modular';
            
            updateTest('test-1', 'pending', 'Test 1: Chargement de l\'application modular...');
            logToConsole('üöÄ D√©marrage du test version modulaire');
            
            const iframe = document.getElementById('test-frame');
            const container = document.getElementById('app-container');
            
            container.style.display = 'block';
            iframe.src = 'weather-map-modular.html';
            
            // Test timeout - should not need more than 10 seconds
            testTimeout = setTimeout(() => {
                updateTest('test-1', 'fail', 'Test 1: TIMEOUT - App pas initialis√©e dans les 10 secondes');
                updateTest('test-2', 'fail', 'Test 2: √âchec - timeout d\'initialisation');
                logToConsole('‚ùå TIMEOUT: App non initialis√©e dans les 10 secondes');
            }, 10000);
            
            // Monitor iframe loading
            iframe.onload = () => {
                logToConsole('üìÑ HTML charg√©, v√©rification de l\'initialisation JavaScript...');
                
                setTimeout(() => {
                    try {
                        const iframeWindow = iframe.contentWindow;
                        const app = iframeWindow.weatherApp;
                        
                        if (app && app.isInitialized) {
                            clearTimeout(testTimeout);
                            const elapsed = Date.now() - testStartTime;
                            
                            updateTest('test-1', 'pass', `Test 1: ‚úÖ App charg√©e et initialis√©e (${elapsed}ms)`);
                            updateTest('test-2', 'pass', 'Test 2: ‚úÖ Initialisation non-bloquante confirm√©e');
                            
                            logToConsole(`‚úÖ App initialis√©e avec succ√®s en ${elapsed}ms`);
                            logToConsole(`‚úÖ Modules: Map=${!!app.mapController}, UI=${!!app.uiState}, Weather=${!!app.weatherService}`);
                            
                            // Show performance metrics
                            if (app.getPerformanceMetrics) {
                                const metrics = app.getPerformanceMetrics();
                                showMetrics(metrics);
                                logToConsole(`üìä M√©triques: ${JSON.stringify(metrics, null, 2)}`);
                            }
                            
                            // Test weather data loading
                            setTimeout(() => {
                                checkWeatherDataLoading(iframeWindow);
                            }, 2000);
                            
                        } else {
                            logToConsole('‚ö†Ô∏è App trouv√©e mais pas encore initialis√©e, attente...');
                            setTimeout(arguments.callee, 500);
                        }
                    } catch (error) {
                        logToConsole(`‚ùå Erreur lors de l'acc√®s √† l'app: ${error.message}`);
                        setTimeout(arguments.callee, 500);
                    }
                }, 1000);
            };
        }
        
        function checkWeatherDataLoading(iframeWindow) {
            try {
                const app = iframeWindow.weatherApp;
                const uiState = app.uiState;
                
                if (uiState && uiState.weatherData) {
                    updateTest('test-3', 'pass', 'Test 3: ‚úÖ Donn√©es m√©t√©o charg√©es avec succ√®s');
                    logToConsole('‚úÖ Donn√©es m√©t√©o disponibles');
                } else {
                    updateTest('test-3', 'pending', 'Test 3: ‚è≥ Donn√©es m√©t√©o en cours de chargement...');
                    logToConsole('‚è≥ Donn√©es m√©t√©o encore en chargement...');
                    
                    // Check again in 3 seconds
                    setTimeout(() => {
                        if (uiState && uiState.weatherData) {
                            updateTest('test-3', 'pass', 'Test 3: ‚úÖ Donn√©es m√©t√©o charg√©es (avec d√©lai)');
                            logToConsole('‚úÖ Donn√©es m√©t√©o finalement disponibles');
                        } else {
                            updateTest('test-3', 'fail', 'Test 3: ‚ö†Ô∏è Donn√©es m√©t√©o non disponibles (normal si hors ligne)');
                            logToConsole('‚ö†Ô∏è Donn√©es m√©t√©o non disponibles - app fonctionne quand m√™me');
                        }
                    }, 3000);
                }
            } catch (error) {
                updateTest('test-3', 'fail', `Test 3: ‚ùå Erreur: ${error.message}`);
                logToConsole(`‚ùå Erreur test donn√©es m√©t√©o: ${error.message}`);
            }
        }
        
        function runSimpleTest() {
            clearTests();
            testStartTime = Date.now();
            currentTest = 'simple';
            
            updateTest('test-4', 'pending', 'Test 4: Chargement de la version simple...');
            logToConsole('üöÄ D√©marrage du test version simple');
            
            const iframe = document.getElementById('test-frame');
            const container = document.getElementById('app-container');
            
            container.style.display = 'block';
            iframe.src = 'weather-map-simple.html';
            
            testTimeout = setTimeout(() => {
                updateTest('test-4', 'fail', 'Test 4: TIMEOUT - Version simple pas charg√©e');
                logToConsole('‚ùå TIMEOUT: Version simple non charg√©e');
            }, 8000);
            
            iframe.onload = () => {
                setTimeout(() => {
                    try {
                        const iframeWindow = iframe.contentWindow;
                        const app = iframeWindow.weatherApp;
                        
                        if (app && app.isInitialized) {
                            clearTimeout(testTimeout);
                            const elapsed = Date.now() - testStartTime;
                            
                            updateTest('test-4', 'pass', `Test 4: ‚úÖ Version simple charg√©e (${elapsed}ms)`);
                            logToConsole(`‚úÖ Version simple initialis√©e en ${elapsed}ms`);
                        } else {
                            setTimeout(arguments.callee, 500);
                        }
                    } catch (error) {
                        logToConsole(`‚ùå Erreur version simple: ${error.message}`);
                        setTimeout(arguments.callee, 500);
                    }
                }, 1000);
            };
        }
        
        function runOfflineTest() {
            logToConsole('üìµ Test mode hors ligne non impl√©ment√© dans ce test');
            alert('Test mode hors ligne: D√©sactivez votre connexion internet et relancez le test modular');
        }
        
        function showMetrics(metrics) {
            const metricsDiv = document.getElementById('metrics');
            const content = document.getElementById('metrics-content');
            
            content.innerHTML = `
                <div><strong>Temps d'initialisation total:</strong> ${metrics.totalInitTime}ms</div>
                <div><strong>Chargement m√©t√©o:</strong> ${metrics.weatherLoadTime || 'En cours...'}ms</div>
                <div><strong>√âtat de l'interface:</strong> ${metrics.uiState?.isInitialized ? 'Pr√™te' : 'En cours'}</div>
                <div><strong>Connexion r√©seau:</strong> ${metrics.weatherServiceStats?.connectionStatus || 'Inconnue'}</div>
                <div><strong>Fiabilit√© service m√©t√©o:</strong> ${metrics.weatherServiceStats?.reliability?.successCount || 0}/${metrics.weatherServiceStats?.reliability?.totalRequests || 0}</div>
            `;
            
            metricsDiv.style.display = 'block';
        }
        
        function clearTests() {
            if (testTimeout) {
                clearTimeout(testTimeout);
                testTimeout = null;
            }
            
            ['test-1', 'test-2', 'test-3', 'test-4'].forEach(id => {
                updateTest(id, 'pending', document.getElementById(id).textContent.split('‚è≥')[1] || 'Test en attente...');
            });
            
            document.getElementById('metrics').style.display = 'none';
            document.getElementById('console-output').style.display = 'none';
            document.getElementById('console-log').innerHTML = '';
            document.getElementById('app-container').style.display = 'none';
        }
        
        // Auto-run modular test on page load
        setTimeout(runModularTest, 1000);
    </script>
</body>
</html>